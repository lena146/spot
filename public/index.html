<!DOCTYPE html>
<html lang="ko" class="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#f8f8f6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>전시장 지도</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet" />
  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
  <!-- Mixpanel -->
  <script>
    (function(f,b){if(!b.__SV){var e,g,i,h;window.mixpanel=b;b._i=[];b.init=function(e,f,c){function g(a,d){var b=d.split(".");2==b.length&&(a=a[b[0]],d=b[1]);a[d]=function(){a.push([d].concat(Array.prototype.slice.call(arguments,0)))}}var a=b;"undefined"!==typeof c?a=b[c]=[]:c="mixpanel";a.people=a.people||[];a.toString=function(a){var d="mixpanel";"mixpanel"!==c&&(d+="."+c);a||(d+=" (stub)");return d};a.people.toString=function(){return a.toString(1)+".people (stub)"};i="disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(" ");for(h=0;h<i.length;h++)g(a,i[h]);var j="set set_once union unset remove delete".split(" ");a.get_group=function(){function b(c){d[c]=function(){call2_args=arguments;call2=[c].concat(Array.prototype.slice.call(call2_args,0));a.push([e].concat([call2]))}}for(var d={},e=["get_group"].concat(Array.prototype.slice.call(arguments,0)),c=0;c<j.length;c++)b(j[c]);return d};b._i.push([e,f,c])};b.__SV=1.2;e=f.createElement("script");e.type="text/javascript";e.async=!0;e.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===f.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";g=f.getElementsByTagName("script")[0];g.parentNode.insertBefore(e,g)}})(document,window.mixpanel||[]);
    mixpanel.init('e6eb2b4fbbd0d92bf1e7004dbbb3fbd5', { track_pageview: true, persistence: 'localStorage' });
  </script>
  <!-- Naver Maps (callback으로 초기화 보장) -->
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=1kw91fyxmy&callback=onNaverMapsReady"></script>

  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#e8c930",
            "primary-dark": "#c9ac20",
            "bg-light": "#f8f8f6",
            "bg-dark": "#211e11",
          },
          fontFamily: {
            "display": ["Inter", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "0.25rem",
            "lg": "0.5rem",
            "xl": "0.75rem",
            "2xl": "1rem",
            "3xl": "1.5rem",
            "full": "9999px"
          },
        },
      },
    }
  </script>

  <style>
    * { -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Inter', sans-serif;
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
    }

    .porcelain-shadow { box-shadow: 0 4px 20px -2px rgba(24, 23, 17, 0.08); }
    .porcelain-shadow-lg { box-shadow: 0 8px 40px -4px rgba(24, 23, 17, 0.12); }

    .glass-nav {
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      background-color: rgba(248, 248, 246, 0.88);
    }

    /* Map container */
    #map {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    .marker-pin {
      width: 36px;
      height: 36px;
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(24,23,17,0.25);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    .marker-pin.museum { background: #e8c930; }
    .marker-pin.gallery { background: #211e11; }
    .marker-pin.active {
      transform: rotate(-45deg) scale(1.2);
      box-shadow: 0 6px 20px rgba(232,201,48,0.5);
    }
    .marker-pin .pin-icon {
      transform: rotate(45deg);
      font-size: 16px;
      color: #211e11;
    }
    .marker-pin.gallery .pin-icon { color: #e8c930; }

    /* Bottom sheet */
    #bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 500;
      transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
      touch-action: none;
    }

    #bottom-sheet.peek { transform: translateY(calc(100% - 200px)); }
    #bottom-sheet.half { transform: translateY(calc(100% - 50vh)); }
    #bottom-sheet.full { transform: translateY(0); }

    /* Scrollable venue list */
    #venue-list {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }

    /* Detail panel */
    #detail-panel {
      position: fixed;
      inset: 0;
      z-index: 600;
      transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
      transform: translateX(100%);
    }
    #detail-panel.open { transform: translateX(0); }

    /* Loading spinner */
    .spinner {
      width: 24px; height: 24px;
      border: 3px solid rgba(232,201,48,0.3);
      border-top-color: #e8c930;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Search bar */
    .search-bar {
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    /* Venue card hover/active */
    .venue-card {
      transition: background-color 0.15s, transform 0.15s;
    }
    .venue-card:active { transform: scale(0.98); background-color: rgba(232,201,48,0.08); }

    /* Safe area insets for iPhone notch */
    .safe-top { padding-top: env(safe-area-inset-top, 0px); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 16px); }

    /* Filter pill active */
    .filter-pill.active {
      background-color: #e8c930;
      color: #211e11;
      border-color: #e8c930;
    }

    /* Status badge */
    .badge-open { background: rgba(34,197,94,0.12); color: #16a34a; }
    .badge-closed { background: rgba(239,68,68,0.12); color: #dc2626; }
  </style>
</head>

<body class="bg-bg-light text-slate-900 font-display overflow-hidden h-screen">

<!-- ── Full-screen map ── -->
<div class="relative w-full h-screen">
  <div id="map"></div>

  <!-- ── Top header (glass) ── -->
  <header class="glass-nav absolute top-0 left-0 right-0 z-400 safe-top border-b border-slate-200/50" style="z-index:400">
    <div class="px-4 py-3 flex items-center gap-3">
      <!-- Logo -->
      <div class="flex items-center gap-2 shrink-0">
        <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center shadow-sm">
          <span class="material-symbols-outlined text-bg-dark text-lg">museum</span>
        </div>
        <span class="text-sm font-black tracking-tight">전시장 finder</span>
      </div>
      <!-- 인터뷰하기 버튼 -->
      <a href="https://www.proby.io/interview?t=1F6O8nlzS" target="_blank" rel="noopener noreferrer"
        onclick="mixpanel.track('Interview Button Clicked')"
        class="shrink-0 flex items-center gap-1.5 bg-primary text-bg-dark text-xs font-black px-3 py-2 rounded-full shadow-sm active:scale-95 transition-transform whitespace-nowrap">
        <span class="material-symbols-outlined text-sm">mic</span>
        인터뷰하기
      </a>
      <!-- Search input -->
      <div class="flex-1 relative">
        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-base">search</span>
        <input
          id="search-input"
          type="text"
          placeholder="전시장 이름 또는 주소 검색"
          class="w-full bg-slate-100/80 border-none rounded-full pl-9 pr-4 py-2 text-sm focus:ring-2 focus:ring-primary/40 focus:bg-white transition-all outline-none"
        />
      </div>
    </div>
    <!-- Filter pills -->
    <div class="px-4 pb-3 flex gap-2 overflow-x-auto no-scrollbar">
      <button class="filter-pill active shrink-0 flex items-center gap-1.5 px-3 py-1.5 rounded-full border border-slate-200 text-xs font-semibold transition-all" data-filter="all">
        <span class="material-symbols-outlined text-xs">apps</span>전체
      </button>
      <button class="filter-pill shrink-0 flex items-center gap-1.5 px-3 py-1.5 rounded-full border border-slate-200 bg-white text-xs font-semibold transition-all" data-filter="박물관">
        <span class="material-symbols-outlined text-xs">museum</span>박물관
      </button>
      <button class="filter-pill shrink-0 flex items-center gap-1.5 px-3 py-1.5 rounded-full border border-slate-200 bg-white text-xs font-semibold transition-all" data-filter="미술관">
        <span class="material-symbols-outlined text-xs">palette</span>미술관
      </button>
      <button class="filter-pill shrink-0 flex items-center gap-1.5 px-3 py-1.5 rounded-full border border-slate-200 bg-white text-xs font-semibold transition-all" data-filter="운영중">
        <span class="material-symbols-outlined text-xs">check_circle</span>운영중
      </button>
    </div>
  </header>

  <!-- ── My location button ── -->
  <button id="locate-btn"
    class="absolute right-4 z-400 bg-white rounded-full w-11 h-11 flex items-center justify-center porcelain-shadow border border-slate-100 active:scale-95 transition-transform"
    style="z-index:400; bottom: 216px;">
    <span class="material-symbols-outlined text-slate-600 text-xl">my_location</span>
  </button>

  <!-- ── Loading overlay ── -->
  <div id="loading-overlay" class="absolute inset-0 z-500 bg-bg-light/90 flex flex-col items-center justify-center gap-4" style="z-index:500">
    <div class="w-14 h-14 bg-primary rounded-2xl flex items-center justify-center shadow-lg shadow-primary/30">
      <span class="material-symbols-outlined text-bg-dark text-3xl">museum</span>
    </div>
    <div class="spinner"></div>
    <p class="text-sm font-medium text-slate-500">전시장 정보를 불러오는 중...</p>
  </div>

  <!-- ── Error state ── -->
  <div id="error-state" class="absolute inset-0 z-500 bg-bg-light flex flex-col items-center justify-center gap-4 px-8 hidden" style="z-index:500">
    <div class="w-16 h-16 bg-red-50 rounded-2xl flex items-center justify-center">
      <span class="material-symbols-outlined text-red-400 text-3xl">error_outline</span>
    </div>
    <div class="text-center">
      <h3 class="font-bold text-slate-800 mb-1">데이터를 불러올 수 없어요</h3>
      <p class="text-sm text-slate-500 leading-relaxed" id="error-msg"></p>
    </div>
    <button onclick="loadVenues()" class="bg-primary text-bg-dark font-bold px-6 py-3 rounded-xl text-sm active:scale-95 transition-transform">
      다시 시도
    </button>
  </div>

  <!-- ── Bottom Sheet ── -->
  <div id="bottom-sheet" class="peek">
    <div class="bg-white rounded-t-3xl porcelain-shadow-lg border-t border-slate-100 overflow-hidden"
         style="max-height: 80vh;">

      <!-- Drag handle + header -->
      <div id="sheet-handle" class="pt-3 pb-2 px-4 cursor-grab active:cursor-grabbing">
        <div class="w-10 h-1 bg-slate-200 rounded-full mx-auto mb-3"></div>
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-base font-black tracking-tight">전시장 목록</h2>
            <p id="venue-count" class="text-xs text-slate-400 mt-0.5">불러오는 중...</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="list-view-btn" class="w-8 h-8 flex items-center justify-center rounded-lg bg-primary text-bg-dark">
              <span class="material-symbols-outlined text-base">list</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Venue list -->
      <div id="venue-list" class="overflow-y-auto safe-bottom" style="max-height: calc(80vh - 80px);">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <!-- ── Detail Panel (slide in from right) ── -->
  <div id="detail-panel" class="bg-bg-light">
    <!-- safe-area aware header -->
    <div class="glass-nav safe-top border-b border-slate-200/50 sticky top-0 z-10">
      <div class="flex items-center gap-3 px-4 py-3">
        <button id="detail-back" class="w-9 h-9 flex items-center justify-center rounded-full bg-white porcelain-shadow">
          <span class="material-symbols-outlined text-slate-700">arrow_back</span>
        </button>
        <span class="text-sm font-bold truncate" id="detail-title"></span>
      </div>
    </div>

    <div class="overflow-y-auto safe-bottom" style="max-height: calc(100vh - 60px);">
      <!-- Hero section -->
      <div id="detail-hero" class="h-48 bg-primary/10 flex items-center justify-center relative overflow-hidden">
        <span class="material-symbols-outlined text-primary/30" style="font-size: 96px;">museum</span>
        <div id="detail-type-badge" class="absolute top-4 left-4 flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold bg-primary text-bg-dark">
          <span class="material-symbols-outlined text-xs">museum</span>
          <span id="detail-type-text"></span>
        </div>
        <div id="detail-status-badge" class="absolute top-4 right-4 px-2.5 py-1 rounded-full text-xs font-bold"></div>
      </div>

      <!-- Content -->
      <div class="px-5 py-6 space-y-5">
        <!-- Name -->
        <div>
          <h1 id="detail-name" class="text-2xl font-black tracking-tight leading-tight"></h1>
          <p id="detail-museum-type" class="text-sm text-slate-500 mt-1"></p>
        </div>

        <!-- Info rows -->
        <div class="bg-white rounded-2xl porcelain-shadow border border-slate-100 divide-y divide-slate-50">
          <div class="flex items-start gap-3 p-4">
            <span class="material-symbols-outlined text-primary text-xl mt-0.5">location_on</span>
            <div>
              <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-0.5">도로명 주소</p>
              <p id="detail-address" class="text-sm font-medium leading-relaxed"></p>
            </div>
          </div>
          <div class="flex items-start gap-3 p-4">
            <span class="material-symbols-outlined text-primary text-xl mt-0.5">domain</span>
            <div>
              <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-0.5">설립 구분</p>
              <p id="detail-ownership" class="text-sm font-medium"></p>
            </div>
          </div>
          <div class="flex items-start gap-3 p-4" id="detail-open-row">
            <span class="material-symbols-outlined text-primary text-xl mt-0.5">calendar_today</span>
            <div>
              <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-0.5">개관일</p>
              <p id="detail-open-date" class="text-sm font-medium"></p>
            </div>
          </div>
        </div>

        <!-- Action buttons -->
        <div class="grid grid-cols-2 gap-3">
          <button id="detail-map-btn"
            class="flex flex-col items-center gap-2 p-4 bg-primary rounded-2xl text-bg-dark font-bold active:scale-95 transition-transform shadow-lg shadow-primary/25">
            <span class="material-symbols-outlined text-2xl">map</span>
            <span class="text-xs font-bold">지도에서 보기</span>
          </button>
          <button id="detail-copy-btn"
            class="flex flex-col items-center gap-2 p-4 bg-white rounded-2xl text-slate-700 font-semibold porcelain-shadow border border-slate-100 active:scale-95 transition-transform">
            <span class="material-symbols-outlined text-2xl text-slate-600">content_copy</span>
            <span class="text-xs font-semibold">주소 복사</span>
          </button>
        </div>
      </div>
    </div>
  </div>

</div><!-- end full-screen container -->

<script>
  // ── State ──────────────────────────────────────────────
  let allVenues = [];
  let filteredVenues = [];
  let markers = {};
  let activeFilter = 'all';
  let activeMarkerId = null;
  let map = null;
  let sheetState = 'peek'; // peek | half | full
  let touchStartY = 0;
  let currentVenueDetail = null;

  // ── Map init ──────────────────────────────────────────
  function initMap() {
    map = new naver.maps.Map('map', {
      center: new naver.maps.LatLng(37.45, 126.87),
      zoom: 12,
      zoomControl: true,
      zoomControlOptions: {
        position: naver.maps.Position.RIGHT_BOTTOM,
      },
      mapDataControl: false,
      scaleControl: false,
    });

    naver.maps.Event.addListener(map, 'click', () => {
      if (sheetState === 'full') setSheetState('half');
    });
  }

  // ── Fetch venues ──────────────────────────────────────
  async function loadVenues() {
    showLoading(true);
    hideError();
    try {
      const res = await fetch('/api/venues');
      const data = await res.json();
      if (!data.success) throw new Error(data.error || '알 수 없는 오류');
      allVenues = data.venues;
      applyFilter(activeFilter);
      showLoading(false);
    } catch (err) {
      showLoading(false);
      showError(err.message);
    }
  }

  // ── Filter logic ──────────────────────────────────────
  function applyFilter(filter) {
    activeFilter = filter;
    const search = document.getElementById('search-input').value.toLowerCase().trim();

    filteredVenues = allVenues.filter(v => {
      const matchFilter = filter === 'all' ||
        (filter === '박물관' && v.type === '박물관') ||
        (filter === '미술관' && v.type === '미술관') ||
        (filter === '운영중' && v.status === '운영중');
      const matchSearch = !search ||
        v.name.toLowerCase().includes(search) ||
        v.address.toLowerCase().includes(search);
      return matchFilter && matchSearch;
    });

    renderMarkers();
    renderList();
    updateCount();
  }

  // ── Markers ───────────────────────────────────────────
  function renderMarkers() {
    // Clear old markers
    Object.values(markers).forEach(m => m.setMap(null));
    markers = {};

    filteredVenues.forEach((venue, idx) => {
      const isMuseum = venue.type === '박물관';
      const markerContent = `
        <div class="marker-pin ${isMuseum ? 'museum' : 'gallery'}" id="pin-${idx}">
          <span class="material-symbols-outlined pin-icon">${isMuseum ? 'museum' : 'palette'}</span>
        </div>`;

      const marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(venue.lat, venue.lng),
        map: map,
        icon: {
          content: markerContent,
          anchor: new naver.maps.Point(18, 44),
        },
      });

      naver.maps.Event.addListener(marker, 'click', () => selectVenue(idx));
      markers[idx] = marker;
    });

    if (filteredVenues.length > 0) {
      const latLngs = filteredVenues.map(v => new naver.maps.LatLng(v.lat, v.lng));
      const bounds = new naver.maps.LatLngBounds(latLngs[0], latLngs[0]);
      latLngs.slice(1).forEach(ll => bounds.extend(ll));
      map.fitBounds(bounds, { top: 100, right: 40, bottom: 220, left: 40 });
    }
  }

  // ── List ──────────────────────────────────────────────
  function renderList() {
    const list = document.getElementById('venue-list');
    if (filteredVenues.length === 0) {
      list.innerHTML = `
        <div class="flex flex-col items-center justify-center py-16 gap-3">
          <span class="material-symbols-outlined text-slate-300" style="font-size:48px">search_off</span>
          <p class="text-sm text-slate-400 font-medium">검색 결과가 없어요</p>
        </div>`;
      return;
    }

    list.innerHTML = filteredVenues.map((v, idx) => {
      const isMuseum = v.type === '박물관';
      const isOpen = v.status === '운영중';
      return `
        <button class="venue-card w-full flex items-center gap-4 px-4 py-3.5 text-left border-b border-slate-50 last:border-0"
          onclick="selectVenue(${idx}); openDetail(${idx})">
          <div class="w-12 h-12 rounded-xl flex items-center justify-center shrink-0 ${isMuseum ? 'bg-primary/15' : 'bg-slate-900/8'}">
            <span class="material-symbols-outlined text-xl ${isMuseum ? 'text-primary-dark' : 'text-slate-700'}">${isMuseum ? 'museum' : 'palette'}</span>
          </div>
          <div class="flex-1 min-w-0">
            <p class="font-bold text-sm truncate">${v.name}</p>
            <p class="text-xs text-slate-400 truncate mt-0.5">${v.address}</p>
            <div class="flex items-center gap-2 mt-1.5">
              <span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${isMuseum ? 'bg-primary/15 text-primary-dark' : 'bg-slate-100 text-slate-600'}">${v.type || '기타'}</span>
              <span class="text-[10px] font-semibold ${isOpen ? 'text-green-600' : 'text-slate-400'}">${isOpen ? '운영중' : v.status || ''}</span>
            </div>
          </div>
          <span class="material-symbols-outlined text-slate-300 text-base shrink-0">chevron_right</span>
        </button>`;
    }).join('');
  }

  function updateCount() {
    const el = document.getElementById('venue-count');
    el.textContent = `${filteredVenues.length}개의 전시장`;
  }

  // ── Select venue (highlight marker + pan to) ──────────
  function selectVenue(idx) {
    if (activeMarkerId !== null) {
      const prevPin = document.getElementById(`pin-${activeMarkerId}`);
      if (prevPin) prevPin.classList.remove('active');
    }
    activeMarkerId = idx;
    const pin = document.getElementById(`pin-${idx}`);
    if (pin) pin.classList.add('active');

    const venue = filteredVenues[idx];
    map.panTo(new naver.maps.LatLng(venue.lat, venue.lng));
    map.setZoom(15);
    setSheetState('peek');

    mixpanel.track('Venue Clicked', {
      venue_name: venue.name,
      venue_type: venue.type,
      venue_status: venue.status,
      venue_address: venue.address,
    });
  }

  // ── Detail panel ──────────────────────────────────────
  function openDetail(idx) {
    const v = filteredVenues[idx];
    currentVenueDetail = v;

    document.getElementById('detail-title').textContent = v.name;
    document.getElementById('detail-name').textContent = v.name;
    document.getElementById('detail-address').textContent = v.address || '주소 정보 없음';
    document.getElementById('detail-ownership').textContent = v.ownership || '정보 없음';
    document.getElementById('detail-museum-type').textContent = v.museumType || '';
    document.getElementById('detail-type-text').textContent = v.type || '기타';

    const isMuseum = v.type === '박물관';
    const typeBadge = document.getElementById('detail-type-badge');
    typeBadge.className = `absolute top-4 left-4 flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold ${isMuseum ? 'bg-primary text-bg-dark' : 'bg-bg-dark text-primary'}`;
    typeBadge.querySelector('span.material-symbols-outlined').textContent = isMuseum ? 'museum' : 'palette';

    const statusBadge = document.getElementById('detail-status-badge');
    const isOpen = v.status === '운영중';
    statusBadge.textContent = v.status || '';
    statusBadge.className = `absolute top-4 right-4 px-2.5 py-1 rounded-full text-xs font-bold ${isOpen ? 'badge-open' : 'badge-closed'}`;

    const openRow = document.getElementById('detail-open-row');
    if (v.openDate) {
      const d = v.openDate;
      const formatted = d.length === 8 ? `${d.slice(0,4)}년 ${d.slice(4,6)}월 ${d.slice(6,8)}일` : d;
      document.getElementById('detail-open-date').textContent = formatted;
      openRow.style.display = 'flex';
    } else {
      openRow.style.display = 'none';
    }

    document.getElementById('detail-panel').classList.add('open');
  }

  function closeDetail() {
    document.getElementById('detail-panel').classList.remove('open');
  }

  // ── Bottom sheet drag ────────────────────────────────
  function setSheetState(state) {
    sheetState = state;
    const sheet = document.getElementById('bottom-sheet');
    sheet.className = `${state}`;
    // Reapply ID
    sheet.id = 'bottom-sheet';
  }

  function initSheetDrag() {
    const handle = document.getElementById('sheet-handle');
    let startY = 0, startState = '';

    handle.addEventListener('touchstart', e => {
      startY = e.touches[0].clientY;
      startState = sheetState;
      e.preventDefault();
    }, { passive: false });

    handle.addEventListener('touchend', e => {
      const dy = e.changedTouches[0].clientY - startY;
      if (Math.abs(dy) < 10) return;
      if (dy < -40) {
        // swipe up
        if (sheetState === 'peek') setSheetState('half');
        else if (sheetState === 'half') setSheetState('full');
      } else if (dy > 40) {
        // swipe down
        if (sheetState === 'full') setSheetState('half');
        else if (sheetState === 'half') setSheetState('peek');
      }
    });
  }

  // ── My location ───────────────────────────────────────
  document.getElementById('locate-btn').addEventListener('click', () => {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(pos => {
      map.panTo(new naver.maps.LatLng(pos.coords.latitude, pos.coords.longitude));
      map.setZoom(14);
    });
  });

  // ── Filter pills ──────────────────────────────────────
  document.querySelectorAll('.filter-pill').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-pill').forEach(b => {
        b.classList.remove('active');
        b.classList.add('bg-white');
      });
      btn.classList.add('active');
      btn.classList.remove('bg-white');
      applyFilter(btn.dataset.filter);
      mixpanel.track('Filter Used', { filter: btn.dataset.filter });
    });
  });

  // ── Search ────────────────────────────────────────────
  let searchTimer;
  document.getElementById('search-input').addEventListener('input', () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => {
      const query = document.getElementById('search-input').value.trim();
      applyFilter(activeFilter);
      if (query.length > 1) mixpanel.track('Search Used', { query });
    }, 250);
  });

  // ── Detail back button ────────────────────────────────
  document.getElementById('detail-back').addEventListener('click', closeDetail);

  // ── Detail: fly to map ────────────────────────────────
  document.getElementById('detail-map-btn').addEventListener('click', () => {
    closeDetail();
    if (currentVenueDetail) {
      map.panTo(new naver.maps.LatLng(currentVenueDetail.lat, currentVenueDetail.lng));
      map.setZoom(16);
    }
  });

  // ── Detail: copy address ──────────────────────────────
  document.getElementById('detail-copy-btn').addEventListener('click', async () => {
    if (!currentVenueDetail) return;
    try {
      await navigator.clipboard.writeText(currentVenueDetail.address);
      mixpanel.track('Address Copied', { venue_name: currentVenueDetail.name });
      const btn = document.getElementById('detail-copy-btn');
      const icon = btn.querySelector('.material-symbols-outlined');
      icon.textContent = 'check_circle';
      icon.classList.add('text-green-500');
      setTimeout(() => {
        icon.textContent = 'content_copy';
        icon.classList.remove('text-green-500');
      }, 1500);
    } catch (_) {}
  });

  // ── Utils ─────────────────────────────────────────────
  function showLoading(v) {
    document.getElementById('loading-overlay').style.display = v ? 'flex' : 'none';
  }
  function showError(msg) {
    document.getElementById('error-msg').textContent = msg;
    document.getElementById('error-state').classList.remove('hidden');
  }
  function hideError() {
    document.getElementById('error-state').classList.add('hidden');
  }

  // ── Boot (네이버 지도 준비 완료 후 실행) ───────────────
  function onNaverMapsReady() {
    initMap();
    initSheetDrag();
    loadVenues();
  }
</script>
</body>
</html>
